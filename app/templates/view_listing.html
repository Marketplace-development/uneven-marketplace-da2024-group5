{% extends "base.html" %}

{% block title %}{{ listing.listing_name }} - ViaVia{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mt-3" style="max-width: 600px;">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="font-size: 14px;">
                    {{ message }}
                    {% if category == 'danger' %}
                        <a href="{{ url_for('main.wallet') }}" class="alert-link">Go to your wallet to recharge.</a>
                    {% endif %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- Background Image -->
<div class="background position-fixed w-100 vh-100 top-0 start-0" style="background-image: url('/static/images/green road.jpg'); background-size: cover; background-position: center; z-index: -1;">
</div>

<!-- Container for Content Box -->
<div class="container-fluid d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 1400px); margin-top: 0px; margin-bottom: 0px;">
    <div class="content-box p-5" style="background: rgba(255, 255, 255, 0.85); border-radius: 10px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); max-width: 800px; margin: 0 auto;">

        <!-- Listing Details Section -->
        <h1 style="color: #3D875F;">{{ listing.listing_name }}</h1>
        <p><strong>Price:</strong> â‚¬{{ listing.price_listing }}</p>
        <p><strong>Description:</strong> {{ listing.description }}</p>
        <p><strong>Created on:</strong> {{ listing.created_at.strftime('%Y-%m-%d') }}</p>
        <p><strong>Place:</strong> {{ listing.place }}</p>

        <!-- Like/Unlike Button -->
        {% if session.get('user_id') %}
            {% if listing.user_id != session.user_id %}  <!-- Prevent liking own listing -->
                <form method="POST" action="{{ url_for('main.like_listing', listing_id=listing.listing_id) }}">
                    {% set liked = listing.likes|selectattr('user_id', 'equalto', session.user_id)|list|length > 0 %}
                    {% if liked %}
                        <button type="submit" formaction="{{ url_for('main.unlike_listing', listing_id=listing.listing_id) }}" class="btn btn-danger w-100 mb-3">
                            Unlike
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-primary w-100 mb-3">Like</button>
                    {% endif %}
                </form>
            {% else %}
                <p>You cannot like your own listing.</p>  <!-- Prevent owner from liking their own listing -->
            {% endif %}
        {% else %}
            <p>Please <a href="{{ url_for('main.login') }}">log in</a> to like this listing.</p>
        {% endif %}

        <!-- Buy Now or Download Button -->
        <div class="text-center">
            {% if session.get('user_id') %}
                {% if transaction_exists %}
                <a href="{{ url_for('main.view_pdf', listing_id=listing.listing_id) }}">View PDF</a>

                {% else %}
                    <!-- Buy Now Button -->
                    <form method="POST" action="{{ url_for('main.view_listing', listing_id=listing.listing_id) }}">
                        <button type="submit" class="btn btn-success w-100">Buy Now</button>
                    </form>
                {% endif %}
            {% else %}
                <p>Please <a href="{{ url_for('main.login') }}">log in</a> to purchase or download this listing.</p>
            {% endif %}
        </div>

        <!-- Reviews Section -->
        <div class="mt-4">
            <h2 style="color: #3D875F;">Reviews</h2>
            <ul class="list-group">
                {% for review in reviews %}
                    <li class="list-group-item">
                        <strong>{{ review.user.username }}:</strong> {{ review.content }}
                    </li>
                {% else %}
                    <li class="list-group-item">No reviews yet.</li>
                {% endfor %}
            </ul>

            <!-- Add Review Button -->
            <div class="mt-3 text-center">
                {% if session.get('user_id') and transaction_exists %}
                    <a href="{{ url_for('main.add_review', listing_id=listing.listing_id) }}" class="btn btn-secondary">
                        Add a Review
                    </a>
                {% else %}
                    <p>You can only review listings you have purchased.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
